name: Windows EXE (Nuitka + Installer)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Versão (tag) ex.: v0.0.5"
        required: true
        type: string
      tag_repository:
        description: "Criar e enviar tag?"
        required: true
        default: true
        type: boolean
      publish_release:
        description: "Publicar Release?"
        required: true
        default: true
        type: boolean

permissions:
  contents: write

jobs:
  build-win:
    runs-on: windows-latest

    steps:
      # ------------------------------------------------------------
      # CHECKOUT
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # TAG (OPCIONAL)
      # ------------------------------------------------------------
      - name: Compute version and names
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $ver = "${{ inputs.version }}"
          }
          elseif ("${{ github.ref }}".StartsWith("refs/tags/")) {
            $ver = "${{ github.ref_name }}"
          }
          else {
            $ver = "dev-${{ github.run_number }}"
          }

          "APP_VER=$ver" | Out-File $env:GITHUB_ENV -Append
          "APP_NAME=ProcessSimul" | Out-File $env:GITHUB_ENV -Append

          Write-Host "APP_VER=$ver | APP_NAME=ProcessSimul"

      - name: Create & push tag
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.tag_repository }}
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${APP_VER}" -m "Release ${APP_VER}" || true
          git push origin "${APP_VER}" || true

      # ------------------------------------------------------------
      # PYTHON
      # ------------------------------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # ------------------------------------------------------------
      # DEPENDÊNCIAS E NUITKA
      # ------------------------------------------------------------
      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install -r requirements.txt
          pip install nuitka ordered-set zstandard

      # ------------------------------------------------------------
      # BUILD NUITKA (STANDALONE, SEM ONEFILE)
      # ------------------------------------------------------------
      - name: Build EXE with Nuitka (Standalone Unpacked)
        shell: pwsh
        run: |
          python -m nuitka `
            --standalone `
            --follow-imports `
            --enable-plugin=tk-inter `
            --windows-icon-from-ico=assets/app.ico `
            --include-data-dir=db=db `
            --assume-yes-for-downloads `
            --remove-output `
            --output-dir=dist `
            main.py

          Write-Host "Conteúdo de dist/:"
          Get-ChildItem dist -Recurse

      # ------------------------------------------------------------
      # RENOMEAR EXE PRINCIPAL
      # ------------------------------------------------------------
      - name: Rename EXE
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Recurse "dist/main.dist" -Filter "*.exe" | Select-Object -First 1
          if (-not $exe) { throw "Nenhum EXE encontrado!" }

          $target = "dist/main.dist/${{ env.APP_NAME }}.exe"
          Move-Item $exe.FullName $target -Force
          Write-Host "EXE Final: $target"

      # ------------------------------------------------------------
      # INSTALAR NSIS E GERAR O INSTALADOR
      # ------------------------------------------------------------
      - name: Install NSIS
        run: choco install nsis -y

      - name: Prepare installer
        shell: pwsh
        run: |
          Copy-Item installer/installer.nsi installer.nsi
          (Get-Content installer.nsi) `
            -replace '\$\{APP_VER\}', '${{ env.APP_VER }}' |
            Set-Content installer.nsi

      - name: Build Installer (NSIS)
        shell: pwsh
        run: |
          makensis installer.nsi
          Write-Host "Arquivos gerados:"
          Get-ChildItem . -Filter "setup_*.exe"

      # ------------------------------------------------------------
      # ARTEFATO
      # ------------------------------------------------------------
      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: installer-${{ env.APP_VER }}
          path: setup_*.exe

      # ------------------------------------------------------------
      # RELEASE
      # ------------------------------------------------------------
      - name: Publish Release
        if: ${{ inputs.publish_release }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.APP_VER }}
          files: setup_*.exe
          generate_release_notes: true