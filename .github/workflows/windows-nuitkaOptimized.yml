name: Windows EXE (Nuitka + Installer Optimized)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Versão (tag) ex.: v0.0.5"
        required: true
        type: string
      tag_repository:
        description: "Criar e enviar tag?"
        default: true
        type: boolean
      publish_release:
        description: "Publicar Release?"
        default: true
        type: boolean

permissions:
  contents: write

jobs:
  build-win:
    runs-on: windows-latest

    steps:

    # ------------------------------------------------------------
    # CHECKOUT
    # ------------------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # ------------------------------------------------------------
    # VARIÁVEIS DE VERSÃO
    # ------------------------------------------------------------
    - name: Compute version and names
      shell: pwsh
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $ver = "${{ inputs.version }}"
        }
        elseif ("${{ github.ref }}".StartsWith("refs/tags/")) {
          $ver = "${{ github.ref_name }}"
        }
        else {
          $ver = "dev-${{ github.run_number }}"
        }

        "APP_VER=$ver" | Out-File $env:GITHUB_ENV -Append
        "APP_NAME=EININDII05_PACTware_ProcessSimul" | Out-File $env:GITHUB_ENV -Append

        Write-Host "Versão: $ver"
        Write-Host "Nome do app: EININDII05_PACTware_ProcessSimul"

    # ------------------------------------------------------------
    # CRIAR TAG
    # ------------------------------------------------------------
    - name: Create & push tag
      if: ${{ github.event_name == 'workflow_dispatch' && inputs.tag_repository }}
      shell: bash
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a "${APP_VER}" -m "Release ${APP_VER}" || true
        git push origin "${APP_VER}" || true

    # ------------------------------------------------------------
    # PYTHON + DEPENDÊNCIAS
    # ------------------------------------------------------------
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install dependencies
      shell: pwsh
      run: |
        python -m pip install --upgrade pip wheel setuptools
        pip install -r requirements.txt
        pip install nuitka ordered-set zstandard

    # ------------------------------------------------------------
    # COMPILAÇÃO COM NUITKA (OTIMIZADA + COMPATÍVEL COM CONTROL)
    # ------------------------------------------------------------
    - name: Build EXE with Nuitka (Optimized)
      shell: pwsh
      run: |
        python -m nuitka `
          --standalone `
          --follow-imports `
          --enable-plugin=tk-inter `
          --windows-icon-from-ico=assets/app.ico `
          --include-data-dir=db=db `
          --lto=yes `
          --assume-yes-for-downloads `
          --python-flag=no_site `
          --python-flag=-O `
          --nofollow-import-to=pytest `
          --nofollow-import-to=IPython `
          --nofollow-import-to=jupyter `
          --nofollow-import-to=pydoc `
          --nofollow-import-to=pydoc_data `
          --nofollow-import-to=tkinter.test `
          --nofollow-import-to=tcl.test `
          --output-dir=dist `
          main.py

        Write-Host "=== Conteúdo dist ==="
        Get-ChildItem dist -Recurse

    # ------------------------------------------------------------
    # DETECTAR .DIST
    # ------------------------------------------------------------
    - name: Detect Nuitka output dir
      id: detect_dist
      shell: pwsh
      run: |
        $dirs = Get-ChildItem dist -Directory

        Write-Host "Pastas encontradas em dist/:"
        $dirs | ForEach-Object { Write-Host $_.Name }

        $d = $dirs | Where-Object { $_.Name -match "dist" } | Select-Object -First 1

        if (-not $d) {
          throw "Nenhuma pasta contendo 'dist' encontrada em dist/. Abortando."
        }

        "DIST_DIR=dist\$($d.Name)" | Out-File $env:GITHUB_ENV -Append
        Write-Host "DIST_DIR detectado automaticamente: dist\$($d.Name)"

    # ------------------------------------------------------------
    # RENOMEAR EXECUTÁVEL
    # ------------------------------------------------------------
    - name: Rename EXE inside .dist
      shell: pwsh
      run: |
        $exe = Get-ChildItem -Recurse "${{ env.DIST_DIR }}" -Filter "*.exe" | Select-Object -First 1
        if (-not $exe) { throw "Nenhum EXE encontrado na pasta .dist" }

        $newpath = Join-Path $exe.Directory.FullName "${{ env.APP_NAME }}.exe"
        Move-Item $exe.FullName $newpath -Force
        Write-Host "Renomeado para: $newpath"

    # ------------------------------------------------------------
    # INSTALAR NSIS
    # ------------------------------------------------------------
    - name: Install NSIS
      shell: pwsh
      run: |
        choco install nsis -y
        $nsis = "${env:ProgramFiles(x86)}\NSIS\makensis.exe"
        if (!(Test-Path $nsis)) { throw "NSIS não encontrado" }
        "NSIS_EXE=$nsis" | Out-File $env:GITHUB_ENV -Append

    # ------------------------------------------------------------
    # PROCESSAR installer.nsi
    # ------------------------------------------------------------
    - name: Prepare installer script
      shell: pwsh
      run: |
        Copy-Item installer/installer.nsi installer_parsed.nsi -Force

        (Get-Content installer_parsed.nsi) `
          -replace '\$\{APP_VERSION\}', '${{ env.APP_VER }}' `
          -replace '\$\{APP_NAME\}', '${{ env.APP_NAME }}' `
          | Set-Content installer_parsed.nsi

        Write-Host "installer_parsed.nsi pronto"

    # ------------------------------------------------------------
    # GERAR INSTALADOR FINAL
    # ------------------------------------------------------------
    - name: Build Installer (NSIS)
      shell: pwsh
      run: |
        & "${{ env.NSIS_EXE }}" installer_parsed.nsi

        Write-Host "Arquivos finais:"
        Get-ChildItem . -Filter "setup_*.exe"

    # ------------------------------------------------------------
    # ARTEFATO
    # ------------------------------------------------------------
    - name: Upload installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: installer-${{ env.APP_VER }}
        path: setup_*.exe

    # ------------------------------------------------------------
    # RELEASE
    # ------------------------------------------------------------
    - name: Publish Release
      if: ${{ inputs.publish_release }}
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.APP_VER }}
        files: setup_*.exe
        generate_release_notes: true
